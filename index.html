<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>General Exam Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; margin: 0; }
    .main-content { margin-right: 320px; }
    .side-menu {
      position: fixed;
      right: 0;
      top: 0;
      width: 300px;
      height: 100%;
      background: #f5f5f5;
      padding: 2rem;
      overflow-y: auto;
      border-left: 1px solid #ccc;
      box-sizing: border-box;
    }
    .exam-result {
      padding: 1rem;
      margin-bottom: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .question-container { margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; }
    .choices label { display: block; margin: 0.3rem 0; }
    #submit-btn { margin-top: 1.5rem; padding: 0.5rem 1rem; font-size: 1rem; }
    #result { margin-top: 2rem; font-size: 1.2rem; font-weight: bold; }
    .correct { background-color: #c8e6c9; }
    .incorrect { background-color: #ffcdd2; }
    .grid-box { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 1rem; }
    .grid-item { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; border: 1px solid #000; }
    .grid-yellow { background-color: yellow; }
    .grid-green { background-color: #4caf50; color: #fff; }
    .grid-red { background-color: #f44336; color: #fff; }
    #timer { font-size: 1.2rem; font-weight: bold; margin-bottom: 1rem; }
    
    .create-exam-section, .select-exam-section { 
      padding: 1rem;
      margin-bottom: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background: #4caf50;
      color: white;
      cursor: pointer;
      margin: 5px 0;
      width: 100%;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .incorrect-questions {
      color: #f44336;
      margin-top: 5px;
    }
    .stats-section {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-height: 400px;
    }
    .progress-chart {
      margin-top: 15px;
      width: 100%;
      height: 300px;
    }
    .exam-selector {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .exam-info {
      padding: 10px;
      margin-bottom: 15px;
      background: #e3f2fd;
      border-radius: 4px;
    }
    .domain-progress {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="main-content">
    <h1>Exam Simulator</h1>
    <div id="exam"></div>
  </div>
  <div class="side-menu" id="side-menu">
    <h2>Exam Controls</h2>
    <div class="control-section">
      <select id="examSelect" class="exam-selector">
        <option value="">-- Select an exam --</option>
      </select>
      <div id="timer" style="margin: 10px 0;"></div>
      <div class="exam-info" id="examInfo"></div>
      <button id="submit-btn" style="display:none; width: 100%;">Submit Exam</button>
      <div class="grid-box" id="gridBox" style="margin: 15px 0;"></div>
      <div id="result"></div>
    </div>
    <div class="stats-section">
      <h3>Exam Statistics</h3>
      <canvas id="progressChart" class="progress-chart"></canvas>
      <div id="domainProgress"></div>
    </div>
    <div id="submission-history"></div>
  </div>

  <script>
    let questions = [];
    let correctAnswers = {};
    let previousResults = {};
    let startTime;
    let currentExam = null;
    let examTimer = null;    async function loadAvailableExams() {
      try {
        console.log('Loading available exams...');
        const response = await fetch('http://localhost:3000/examSIm/examsBank/');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const jsonFiles = await response.json();
        console.log('JSON files found:', jsonFiles);

        const examSelect = document.getElementById('examSelect');
        examSelect.innerHTML = '<option value="">-- Select an exam --</option>';

        for (const file of jsonFiles) {
          try {
            const examResponse = await fetch(`http://localhost:3000/examSIm/examsBank/${file}`);
            if (!examResponse.ok) {
              console.error(`Failed to load exam ${file}:`, examResponse.statusText);
              continue;
            }
            const examData = await examResponse.json();
            if (examData.examInfo && examData.examInfo.name) {
              const option = document.createElement('option');
              option.value = file;
              option.textContent = examData.examInfo.name;
              examSelect.appendChild(option);
            } else {
              console.error(`Exam ${file} is missing required metadata`);
            }
          } catch (examError) {
            console.error(`Error loading exam ${file}:`, examError);
          }
        }
      } catch (error) {
        console.error('Error loading exams:', error);
        document.getElementById('examSelect').innerHTML = '<option value="">Error loading exams</option>';
      }
    }

    document.getElementById('examSelect').addEventListener('change', async function() {
      const selectedFile = this.value;
      if (!selectedFile) return;      const response = await fetch(`http://localhost:3000/examSIm/examsBank/${selectedFile}`);
      const examData = await response.json();
      currentExam = examData;
      loadExam(examData);
      startTime = Date.now();
      if (examTimer) clearInterval(examTimer);
      examTimer = startTimer();
      
      // Display exam info
      document.getElementById("examInfo").innerHTML = `
        <strong>${examData.examInfo.name}</strong><br>
        Time Limit: ${examData.examInfo.totalTime} minutes<br>
        Total Questions: ${examData.examInfo.totalQuestions}<br>
        <div class="domain-distribution">
          <h4>Domain Distribution:</h4>
          ${Object.entries(examData.examInfo.domainDistribution)
            .map(([domain, percentage]) => 
              `${domain}: ${Math.round(percentage * 100)}%`
            ).join('<br>')}
        </div>
      `;
    });

    function createExam(name, jsonData) {
      examData[name] = jsonData;
      localStorage.setItem('exam_data', JSON.stringify(examData));
      updateExamSelect();
    }

    function loadExamData() {
      previousResults = JSON.parse(localStorage.getItem('all_exam_results')) || {};
      updateSubmissionHistory();
    }

    function saveExamResults(examId, results) {
      previousResults[examId] = previousResults[examId] || [];
      previousResults[examId].push(results);
      localStorage.setItem('all_exam_results', JSON.stringify(previousResults));
      updateSubmissionHistory();
      updateExamStatistics(examId);
    }

    function updateSubmissionHistory() {
      const savedExamsDiv = document.getElementById("saved-exams");
      const historyDiv = document.getElementById("submission-history");
      savedExamsDiv.innerHTML = "";
      historyDiv.innerHTML = "";
      
      // Create exam selector
      Object.keys(previousResults).forEach(examName => {
        const examButton = document.createElement("div");
        examButton.className = "exam-result";
        examButton.style.cursor = "pointer";
        examButton.innerHTML = `<strong>${examName}</strong>`;
        examButton.onclick = () => showExamHistory(examName);
        savedExamsDiv.appendChild(examButton);
      });
    }

    function updateExamSelect() {
      const examSelect = document.getElementById("examSelect");
      examSelect.innerHTML = `<option value="">-- Select an exam --</option>`;
      
      Object.keys(examData).forEach(examName => {
        const option = document.createElement("option");
        option.value = examName;
        option.textContent = examName;
        examSelect.appendChild(option);
      });
    }

    function showExamHistory(examName) {
      const historyDiv = document.getElementById("submission-history");
      historyDiv.innerHTML = "";
      
      const results = previousResults[examName] || [];
      results.slice().reverse().forEach((result, index) => {
        const date = new Date(result.timestamp);
        const incorrectQuestions = Object.keys(result.answers)
          .filter(qId => result.answers[qId] !== result.correctAnswers[qId])
          .map(qId => qId.slice(1))  // Remove 'Q' prefix
          .sort((a, b) => Number(a) - Number(b)); // Sort numerically
        
        const resultDiv = document.createElement("div");
        resultDiv.className = "exam-result";
        resultDiv.innerHTML = `
          <strong>Attempt ${results.length - index}</strong><br>
          <small>${date.toLocaleString()}</small><br>
          Score: ${result.score}/${result.total}<br>
          Time: ${Math.floor(result.time / 60)}m ${result.time % 60}s<br>
          ${incorrectQuestions.length ? `<div class="incorrect-questions">Incorrect: Q${incorrectQuestions.join(', Q')}</div>` : ''}
        `;
        historyDiv.appendChild(resultDiv);
      });

      // Update exam statistics
      updateExamStatistics(examName);
    }

    function updateExamStatistics(examId) {
      const statsSection = document.querySelector(".stats-section");
      const progressChart = document.getElementById("progressChart");
      const domainProgress = document.getElementById("domainProgress");

      const results = previousResults[examId] || [];
      if (results.length === 0) {
        statsSection.style.display = "none";
        return;
      }

      statsSection.style.display = "block";

      // Clear previous chart if it exists
      if (window.examChart) {
        window.examChart.destroy();
      }

      // Prepare data for the chart
      const labels = results.map((_, index) => `Attempt ${index + 1}`);
      const scores = results.map(r => r.score);
      const correctCounts = results.map(r => Object.keys(r.answers).filter(qId => r.answers[qId] === correctAnswers[qId]).length);
      const wrongCounts = results.map(r => Object.keys(r.answers).filter(qId => r.answers[qId] !== correctAnswers[qId]).length);

      // Create the chart
      window.examChart = new Chart(progressChart, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Score',
              data: scores,
              borderColor: '#4caf50',
              tension: 0.1,
              fill: false
            },
            {
              label: 'Correct Answers',
              data: correctCounts,
              borderColor: '#2196f3',
              tension: 0.1,
              fill: false
            },
            {
              label: 'Wrong Answers',
              data: wrongCounts,
              borderColor: '#f44336',
              tension: 0.1,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Questions'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Attempts'
              }
            }
          }
        }
      });

      // Update domain progress
      domainProgress.innerHTML = "<h4>Domain Progress</h4>";
      if (currentExam && currentExam.examInfo.domainDistribution) {
        Object.entries(currentExam.examInfo.domainDistribution).forEach(([domain, percentage]) => {
          const domainQuestions = questions.filter(q => q.domain === domain);
          const lastResult = results[results.length - 1];
          const correct = domainQuestions.filter(q => lastResult.answers[q.id] === correctAnswers[q.id]).length;
          const total = domainQuestions.length;
          
          domainProgress.innerHTML += `
            <div class="domain-progress">
              <strong>${domain}</strong><br>
              Score: ${correct}/${total} (${Math.round(correct/total * 100)}%)<br>
              Target: ${Math.round(percentage * 100)}% of exam
            </div>
          `;
        });
      }
    }

    document.getElementById("jsonInput").addEventListener("change", function(event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const data = JSON.parse(e.target.result);
        currentExam = data;
        loadExam(data);
        startTime = Date.now();
        startTimer();
        
        // Display exam info
        document.getElementById("examInfo").innerHTML = `
          <strong>${data.examInfo.name}</strong><br>
          Time Limit: ${data.examInfo.totalTime} minutes<br>
          Total Questions: ${data.examInfo.totalQuestions}
        `;
      };

      reader.readAsText(file);
    });

    function startTimer() {
      const timerDiv = document.getElementById("timer");
      const endTime = Date.now() + (currentExam.examInfo.totalTime * 60 * 1000);
      
      const timerInterval = setInterval(() => {
        const now = Date.now();
        const timeLeft = Math.max(0, endTime - now);
        const elapsed = now - startTime;
        
        const minutesLeft = Math.floor(timeLeft / 60000);
        const secondsLeft = Math.floor((timeLeft % 60000) / 1000);
        
        if (timeLeft === 0) {
          clearInterval(timerInterval);
          document.getElementById("submit-btn").click();
        }
        
        timerDiv.innerHTML = `
          Time Left: ${minutesLeft}:${secondsLeft.toString().padStart(2, '0')}<br>
          Elapsed: ${Math.floor(elapsed/60000)}:${Math.floor((elapsed%60000)/1000).toString().padStart(2, '0')}
        `;
      }, 1000);

      return timerInterval;
    }

    function getDomainProgress(examId) {
      const results = previousResults[examId] || [];
      if (results.length < 2) return null;

      const last = results[results.length - 1];
      const secondLast = results[results.length - 2];
      const progress = {};

      currentExam.domains.forEach(domain => {
        const domainQuestions = questions.filter(q => q.domain === domain.domain);
        const correct = domainQuestions.filter(q => last.answers[q.id] === q.correct).length;
        const prevCorrect = domainQuestions.filter(q => secondLast.answers[q.id] === q.correct).length;
        const improvement = correct - prevCorrect;

        progress[domain.domain] = {
          correct,
          total: domainQuestions.length,
          improvement,
          percentage: Math.round((correct / domainQuestions.length) * 100)
        };
      });

      return progress;
    }

    function loadExam(data) {
      const examDiv = document.getElementById("exam");
      const gridBox = document.getElementById("gridBox");
      examDiv.innerHTML = "";
      document.getElementById("result").innerHTML = "";
      gridBox.innerHTML = "";
      questions = [];
      correctAnswers = {};

      let qCounter = 0;
      data.domains.forEach(domain => {
        // Add domain header
        const domainHeader = document.createElement("h3");
        domainHeader.textContent = domain.domain;
        examDiv.appendChild(domainHeader);

        domain.questions.forEach((q, index) => {
          const qId = q.id || `Q${qCounter + 1}`;
          questions.push({ 
            id: qId, 
            correct: q.correct_choice, 
            explanation: q.explanation,
            domain: domain.domain 
          });
          correctAnswers[qId] = q.correct_choice;

          const container = document.createElement("div");
          container.className = "question-container";
          container.id = qId;

          const qText = document.createElement("p");
          qText.innerHTML = `<strong>${qId}. ${q.question}</strong>`;
          container.appendChild(qText);

          const choices = document.createElement("div");
          choices.className = "choices";

          Object.entries(q.choices).forEach(([key, val]) => {
            const label = document.createElement("label");
            const input = document.createElement("input");
            input.type = "radio";
            input.name = qId;
            input.value = key;
            label.appendChild(input);
            label.append(` ${key}: ${val}`);
            choices.appendChild(label);
          });

          container.appendChild(choices);
          examDiv.appendChild(container);

          const gridItem = document.createElement("div");
          gridItem.className = "grid-item grid-yellow";
          gridItem.id = `grid-${qId}`;
          gridItem.innerText = qId.replace('Q', '');
          gridBox.appendChild(gridItem);

          qCounter++;
        });
      });

      document.getElementById("submit-btn").style.display = "inline-block";
    }

    document.getElementById("submit-btn").onclick = function() {
      let score = 0;
      let wrong = 0;
      let unanswered = 0;
      const answers = {};
      const incorrectQuestions = [];

      questions.forEach(q => {
        const selected = document.querySelector(`input[name='${q.id}']:checked`);
        const container = document.getElementById(q.id);
        const gridItem = document.getElementById(`grid-${q.id}`);

        if (!selected) {
          unanswered++;
          gridItem.className = "grid-item grid-yellow";
          return;
        }

        answers[q.id] = selected.value;

        if (selected.value === q.correct) {
          score++;
          container.classList.add("correct");
          gridItem.className = "grid-item grid-green";
        } else {
          wrong++;
          container.classList.add("incorrect");
          incorrectQuestions.push(q.id);
          const explanation = document.createElement("p");
          explanation.innerHTML = `<strong>Explanation:</strong> ${q.explanation}`;
          container.appendChild(explanation);
          gridItem.className = "grid-item grid-red";
        }
      });

      const total = questions.length;
      const elapsedSecs = Math.floor((Date.now() - startTime) / 1000);

      const examResult = {
        timestamp: Date.now(),
        score,
        total,
        time: elapsedSecs,
        answers,
        incorrectQuestions,
        correctAnswers: Object.fromEntries(questions.map(q => [q.id, q.correct])),
        domains: Object.fromEntries(questions.map(q => [q.id, q.domain]))
      };

      // Save results to localStorage
      const examId = currentExam.examInfo.name;
      previousResults[examId] = previousResults[examId] || [];
      previousResults[examId].push(examResult);
      localStorage.setItem('all_exam_results', JSON.stringify(previousResults));

      // Calculate wrong answers that were wrong in previous attempt
      let wrongBefore = 0;
      if (previousResults[examId].length > 1) {
        const lastResult = previousResults[examId][previousResults[examId].length - 2];
        wrongBefore = incorrectQuestions.filter(qId => 
          lastResult.incorrectQuestions.includes(qId)
        ).length;
      }

      document.getElementById("result").innerHTML = `
        <strong>Your Score: ${score}/${total} (${Math.round(score/total * 100)}%)</strong><br>
        Time Taken: ${Math.floor(elapsedSecs/60)}m ${elapsedSecs%60}s<br>
        Correct: ${score}, Wrong: ${wrong}, Unanswered: ${unanswered}<br>
        ${wrongBefore ? `<span style="color: #f44336">Previously wrong again: ${wrongBefore}</span><br>` : ''}
        ${incorrectQuestions.length ? `<div class="incorrect-questions">Incorrect: ${incorrectQuestions.join(', ')}</div>` : ''}
      `;

      updateExamStatistics(examId);
    };

    document.getElementById("create-exam-btn").onclick = function() {
      const newExamJson = document.getElementById("newExamJson").value.trim();
      if (!newExamJson) {
        alert("Please enter or paste the exam JSON.");
        return;
      }

      try {
        const examJson = JSON.parse(newExamJson);
        const examName = document.getElementById("examName").value.trim();
        if (!examName) {
          alert("Please enter an exam name.");
          return;
        }
        createExam(examName, examJson);
        document.getElementById("newExamJson").value = "";
        document.getElementById("examName").value = "";
        alert("New exam created and saved.");
      } catch (e) {
        alert("Invalid JSON format. Please check your JSON data.");
      }
    };

    document.getElementById("examSelect").addEventListener("change", function() {
      const examName = this.value;
      const loadButton = document.getElementById("load-exam-btn");
      loadButton.disabled = !examName;
    });

    document.getElementById("load-exam-btn").onclick = function() {
      const examName = document.getElementById("examSelect").value;
      if (!examName) return;

      currentExamName = examName;
      document.getElementById("examName").value = examName;
      loadExam(examData[examName]);
      startTime = Date.now();
      startTimer();
    };

    // Call loadAvailableExams on page load
    loadAvailableExams();
  </script>
</body>
</html>
